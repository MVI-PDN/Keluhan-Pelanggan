<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microvision QC System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js & Datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Configuration -->
    <script>
        const tailwindConfig = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 800: '#075985', 900: '#0c4a6e' },
                    }
                }
            }
        };

        if (typeof tailwind !== 'undefined') {
            tailwind.config = tailwindConfig;
        } else {
            window.addEventListener('load', function() {
                if (typeof tailwind !== 'undefined') {
                    tailwind.config = tailwindConfig;
                }
            });
        }
    </script>

    <style>
        /* Base Styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .chart-container { position: relative; width: 100%; height: 350px; }
        @media (min-width: 768px) { .chart-container { height: 380px; } }
        
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Status Colors */
        .status-pending { @apply bg-red-100 text-red-800 border border-red-200; }
        .status-closed { @apply bg-green-100 text-green-800 border border-green-200; }

        /* Aging Colors */
        .aging-new { @apply text-green-600 font-bold; }
        .aging-med { @apply text-yellow-600 font-bold; }
        .aging-old { @apply text-red-600 font-bold; }

        /* Helpers */
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        .preview-wrapper:hover .delete-btn { opacity: 1; }
        .img-preview-container:hover .img-popover { display: block; }

        /* Inputs */
        .input-readonly { background-color: transparent; border-color: transparent; padding: 0; font-weight: 500; color: #1e293b; pointer-events: none; }
        .input-editable { background-color: #ffffff; border-color: #cbd5e1; padding: 0.25rem 0.5rem; pointer-events: auto; }
        
        /* Prevent Body Scroll when Modal is open */
        body.modal-open { overflow: hidden; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans leading-relaxed overflow-x-hidden">

    <!-- TOAST NOTIFICATION -->
    <div id="toast-notification" class="fixed top-5 right-5 z-[10000] hidden transition-all duration-500 transform translate-x-full opacity-0">
        <div class="flex items-center w-full max-w-sm p-4 bg-white rounded-lg shadow-lg border-l-4 border-green-500">
            <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/></svg>
            </div>
            <div class="ml-3 text-sm font-normal text-slate-700">
                <span class="font-bold block text-slate-900">Sukses!</span>
                <span id="toast-message">Data berhasil disimpan.</span>
            </div>
        </div>
    </div>

    <!-- DETAIL / ACTION MODAL -->
    <div id="detail-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-70 z-[9999] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl border border-slate-100 w-full max-w-5xl max-h-[90vh] overflow-y-auto relative fade-in flex flex-col md:flex-row overflow-hidden">
            
            <!-- Left: Informasi Laporan (EDITABLE) -->
            <div class="w-full md:w-1/2 p-6 bg-slate-50 border-r border-slate-200 overflow-y-auto">
                <div class="mb-6 border-b border-slate-200 pb-4 flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">No PO / SPK</p>
                        <input type="text" id="modal-display-po" class="text-2xl font-bold text-brand-700 bg-transparent border-none p-0 w-full focus:ring-0 input-readonly" readonly>
                        <p class="text-xs text-slate-400 mt-1" id="modal-id">ID: MCV-...</p>
                    </div>
                    <!-- EDIT BUTTON -->
                    <button onclick="toggleEditMode()" id="btn-edit-toggle" class="text-xs flex items-center gap-1 text-blue-600 hover:text-blue-800 font-bold bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-200 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        Edit Data
                    </button>
                </div>
                
                <div class="space-y-3 text-sm">
                    <!-- EDITABLE FIELDS GRID -->
                    <div class="grid grid-cols-3 gap-2 items-center">
                        <div class="text-slate-500 col-span-1">Tanggal</div>
                        <div class="col-span-2"><input type="text" id="modal-date" class="w-full text-sm input-readonly rounded" readonly></div>
                        
                        <div class="text-slate-500 col-span-1">Sales</div>
                        <div class="col-span-2"><input type="text" id="modal-sales" class="w-full text-sm input-readonly rounded" readonly></div>

                        <div class="text-slate-500 col-span-1">No HP (WA)</div>
                        <div class="col-span-2 flex items-center gap-2">
                            <input type="text" id="modal-sales-phone" class="w-full text-sm input-readonly rounded text-blue-600" readonly>
                            <a id="btn-wa-sales" href="#" target="_blank" class="hidden text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg transition shadow-sm font-bold no-underline">
                                Chat Sales
                            </a>
                        </div>
                        
                        <div class="text-slate-500 col-span-1">Customer</div>
                        <div class="col-span-2"><input type="text" id="modal-customer" class="w-full text-sm input-readonly rounded" readonly></div>
                        
                        <div class="text-slate-500 col-span-1">Project</div>
                        <div class="col-span-2"><input type="text" id="modal-project" class="w-full text-sm input-readonly rounded" readonly></div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border border-slate-200 space-y-2 mt-4">
                        <div>
                            <p class="text-xs text-slate-500">Produk:</p>
                            <input type="text" id="modal-product" class="w-full font-bold text-slate-800 input-readonly rounded" readonly>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">SN / Batch:</p>
                            <textarea id="modal-batch" rows="2" class="w-full font-mono text-slate-600 text-xs input-readonly rounded resize-none" readonly></textarea>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">Masalah:</p>
                            <input type="text" id="modal-issue" class="w-full font-medium text-red-600 input-readonly rounded" readonly>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500">Permintaan:</p>
                            <input type="text" id="modal-request" class="w-full font-medium text-slate-700 input-readonly rounded" readonly>
                        </div>
                    </div>

                    <div>
                        <p class="text-xs text-slate-500 mb-1">Kronologi:</p>
                        <textarea id="modal-chronology" rows="3" class="w-full p-2 bg-white rounded-lg border border-slate-200 text-slate-600 text-xs leading-relaxed input-readonly" readonly></textarea>
                    </div>

                    <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-slate-200">
                        <span class="text-xs text-slate-500">Bukti Dokumentasi:</span>
                        <span id="modal-evidence">-</span>
                    </div>

                    <!-- SAVE EDIT BUTTON -->
                    <div id="edit-actions" class="hidden pt-2 flex justify-end gap-2">
                        <button onclick="cancelEditMode()" class="px-3 py-1.5 rounded text-xs font-bold text-slate-500 hover:bg-slate-100 border border-slate-300">Batal</button>
                        <button onclick="saveDataEdit()" id="btn-save-data" class="px-3 py-1.5 rounded text-xs font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-sm">Simpan Perubahan Data</button>
                    </div>
                </div>
            </div>

            <!-- Right: Form Tindak Lanjut Admin -->
            <div class="w-full md:w-1/2 p-6 flex flex-col">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-brand-900">Tindak Lanjut</h3>
                        <p class="text-xs text-slate-500">Perhatikan Data untuk memastikan tidak ada kesalahan.</p>
                    </div>
                    <button onclick="closeDetailModal()" class="text-slate-400 hover:text-slate-600 font-bold text-xl">√ó</button>
                </div>

                <div class="space-y-4 flex-grow">
                    <!-- Status -->
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Update Status</label>
                        <select id="modal-status-select" onchange="toggleAdminFields()" class="w-full rounded-lg border-slate-300 p-2.5 text-sm focus:ring-brand-500 focus:border-brand-500 bg-slate-50 font-medium">
                            <option value="Pending" class="text-red-600">üî¥ Pending</option>
                            <option value="Closed" class="text-green-600">üü¢ Closed (Selesai)</option>
                        </select>
                    </div>

                    <!-- Isian Admin (Hidden by default) -->
                    <div id="admin-fields-container" class="hidden p-4 bg-brand-50 rounded-xl border border-brand-100 space-y-3 transition-all duration-300">
                        <div>
                            <label class="block text-xs font-semibold text-brand-800 mb-1">Tanggal Update</label>
                            <input type="date" id="modal-update-date" class="w-full rounded border-brand-200 p-2 text-sm bg-white text-slate-600" readonly>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-brand-800 mb-1">No PO / SPK (Referensi)</label>
                            <input type="text" id="modal-ref-po" class="w-full rounded border-brand-200 p-2 text-sm bg-slate-100 text-slate-500" readonly>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-brand-800 mb-1">Catatan Penyelesaian</label>
                            <textarea id="modal-admin-notes" rows="6" class="w-full rounded border-brand-200 p-2.5 text-sm focus:ring-brand-500 leading-relaxed" placeholder="Tulis analisis kerusakan, tindakan yang diambil, atau info pengiriman unit di sini..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Placeholder when Pending -->
                    <div id="pending-placeholder" class="p-6 text-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">
                        <p class="text-sm">Status masih <strong>Pending</strong>.</p>
                        <p class="text-xs">Ubah ke <strong>Closed</strong> untuk mengisi data penyelesaian.</p>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-slate-100">
                    <button onclick="saveCaseUpdate()" id="btn-save-update" class="w-full bg-brand-900 text-white py-3 rounded-lg font-bold hover:bg-brand-800 transition shadow-lg text-sm flex justify-center items-center gap-2 transform active:scale-95 duration-150">
                        <span>Simpan Status & Catatan</span>
                    </button>
                    <p class="text-[10px] text-center text-slate-400 mt-2 italic">*Perhatikan Data untuk memastikan tidak ada kesalahan.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN & APP -->
    <div id="login-overlay" class="hidden fixed inset-0 bg-slate-900 bg-opacity-60 z-[9998] flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white p-8 rounded-2xl shadow-2xl border border-slate-100 max-w-sm w-full text-center relative fade-in">
            <button onclick="hideLogin()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition font-bold text-xl">√ó</button>
            <img src="https://raw.githubusercontent.com/MVI-PDN/Keluhan-Pelanggan/main/microvision-logo.webp" alt="Microvision Logo" class="h-12 mx-auto mb-6 object-contain" onerror="this.style.display='none'; document.getElementById('login-logo-text').classList.remove('hidden')">
            <h1 id="login-logo-text" class="text-4xl font-bold text-brand-900 italic mb-4 tracking-wide hidden">Microvision</h1>
            <h2 class="text-lg font-semibold text-slate-600 mb-6 uppercase tracking-wider">LOGIN SEBAGAI ADMIN</h2>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="email" id="login-email" required class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-brand-500 outline-none text-sm transition text-center">
                <button type="submit" class="w-full bg-brand-900 text-white py-3 rounded-lg font-bold hover:bg-brand-800 transition shadow-md text-sm">Masuk</button>
            </form>
            <p class="mt-4 text-[10px] text-slate-400">Khusus untuk Tim QC & Management</p>
        </div>
    </div>

    <div id="app-container" class="min-h-screen flex flex-col">
        <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-3">
                        <img src="https://raw.githubusercontent.com/MVI-PDN/Keluhan-Pelanggan/main/microvision-logo.webp" alt="Microvision Logo" class="h-8 w-auto object-contain" onerror="this.style.display='none'; document.getElementById('nav-logo-text').classList.remove('hidden')">
                        <h1 id="nav-logo-text" class="font-bold text-brand-900 text-2xl leading-tight italic tracking-wide hidden">Microvision</h1>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="switchTab('dashboard')" id="nav-dashboard" class="hidden px-4 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors">Dashboard</button>
                        <button onclick="switchTab('form')" id="nav-form" class="px-4 py-2 rounded-md text-sm font-medium bg-brand-50 text-brand-600 border border-brand-100 transition-colors shadow-sm">Laporan Baru</button>
                        <button id="btn-login-trigger" onclick="showLogin()" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-brand-900 hover:bg-brand-800 transition-colors shadow-sm">Login Admin</button>
                        <div id="user-panel" class="hidden flex items-center border-l pl-4 ml-2 gap-3">
                            <div class="text-right hidden md:block">
                                <span class="block text-xs font-bold text-slate-700" id="user-display">User</span>
                                <span class="block text-[10px] text-slate-400" id="role-display">Admin</span>
                            </div>
                            <button onclick="logout()" class="text-slate-400 hover:text-red-500 transition" title="Logout">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">
            <!-- DASHBOARD -->
            <section id="dashboard-view" class="hidden space-y-8 fade-in">
                <div class="flex justify-between items-end bg-white rounded-xl p-6 border border-slate-200 shadow-sm gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">DASHBOARD PENGADUAN</h2>
                        <p class="text-slate-600 text-sm mt-1">Data Real-time dari Google Sheets.</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <select id="filter-status" onchange="applyFilters()" class="text-xs bg-white border border-slate-300 text-slate-700 py-2 px-3 rounded-lg">
                            <option value="all">Semua Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Closed">Closed</option>
                        </select>
                        <select id="filter-month" onchange="applyFilters()" class="text-xs bg-white border border-slate-300 text-slate-700 py-2 px-3 rounded-lg">
                            <option value="all">Semua Bulan</option>
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Maret</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Agustus</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Desember</option>
                        </select>
                        <select id="filter-year" onchange="applyFilters()" class="text-xs bg-white border border-slate-300 text-slate-700 py-2 px-3 rounded-lg">
                            <option value="all">Semua Tahun</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                        </select>
                        <button onclick="downloadExcel()" class="text-xs font-bold bg-green-50 hover:bg-green-100 text-green-700 border border-green-200 px-4 py-2 rounded-lg transition flex items-center gap-2">üì• Excel</button>
                        <button onclick="fetchData()" class="text-xs font-bold bg-slate-50 hover:bg-slate-100 text-slate-600 border border-slate-200 px-4 py-2 rounded-lg transition flex items-center gap-2">üîÑ Refresh</button>
                    </div>
                </div>

                <!-- Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 shadow-sm">
                        <h3 class="text-xs font-bold text-blue-800 uppercase tracking-wider">Total Kasus</h3>
                        <span class="text-3xl font-bold text-blue-600 mt-2 block" id="total-reports">...</span>
                    </div>
                    <div class="bg-red-50 p-6 rounded-xl border border-red-100 shadow-sm">
                        <h3 class="text-xs font-bold text-red-800 uppercase tracking-wider">Pending</h3>
                        <span class="text-3xl font-bold text-red-600 mt-2 block" id="pending-reports">...</span>
                        <div class="w-full bg-red-200 h-1 mt-3 rounded-full overflow-hidden"><div id="bar-pending" class="bg-red-500 h-full" style="width: 0%"></div></div>
                    </div>
                    <div class="bg-green-50 p-6 rounded-xl border border-green-100 shadow-sm">
                        <h3 class="text-xs font-bold text-green-800 uppercase tracking-wider">Closed</h3>
                        <span class="text-3xl font-bold text-green-600 mt-2 block" id="closed-reports">...</span>
                        <div class="w-full bg-green-200 h-1 mt-3 rounded-full overflow-hidden"><div id="bar-closed" class="bg-green-500 h-full" style="width: 0%"></div></div>
                    </div>
                </div>

                <!-- Tables & Charts -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                    <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <h3 class="font-bold text-lg text-slate-800" id="queue-section-title">üìã Antrian Kasus (Pending)</h3>
                        <div class="relative w-full md:w-64">
                            <input type="text" id="search-input" onkeyup="applyFilters()" class="block w-full p-2 pl-4 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-brand-500" placeholder="Cari No PO / SPK...">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200 sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-4 font-bold text-left w-32">Tanggal</th>
                                    <th class="px-6 py-4 font-bold text-left">No PO / SPK</th>
                                    <th class="px-6 py-4 font-bold text-left">Project</th>
                                    <th class="px-6 py-4 font-bold text-left">Sales</th>
                                    <th class="px-6 py-4 font-bold text-left">Masalah</th>
                                    <th class="px-6 py-4 font-bold text-center">Bukti</th> 
                                    <th class="px-6 py-4 font-bold text-center">Status</th>
                                    <th class="px-6 py-4 font-bold text-center">Aging</th>
                                    <th class="px-6 py-4 font-bold text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="case-table-body" class="divide-y divide-slate-100">
                                <tr><td colspan="9" class="px-6 py-8 text-center text-slate-400 italic">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-slate-100 flex justify-end gap-2" id="queue-pagination"></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-4"> 
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="chart-container"><canvas id="categoryChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="chart-container"><canvas id="urgencyChart"></canvas></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col mt-6" id="history-section">
                    <div class="p-6 border-b border-slate-100 bg-slate-50">
                        <h3 class="font-bold text-lg text-slate-700">üóÑÔ∏è Histori Kasus Selesai (Closed)</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-100 border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-3 font-bold text-left">Tanggal</th>
                                    <th class="px-6 py-3 font-bold text-left">No PO / SPK</th>
                                    <th class="px-6 py-3 font-bold text-left">Project</th>
                                    <th class="px-6 py-3 font-bold text-left">Sales</th>
                                    <th class="px-6 py-3 font-bold text-left">Masalah</th>
                                    <th class="px-6 py-3 font-bold text-center">Status</th>
                                    <th class="px-6 py-3 font-bold text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-slate-100">
                                <tr><td colspan="7" class="px-6 py-8 text-center text-slate-400 italic">Memuat histori...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-slate-100 flex justify-end gap-2" id="history-pagination"></div>
                </div>
            </section>

            <!-- FORM VIEW -->
            <section id="form-view" class="fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">Formulir Keluhan Baru</h2>
                            <p class="text-slate-600 mb-6 text-sm">Lengkapi data teknis untuk analisis QC.</p>

                            <form id="complaintForm" class="space-y-8" onsubmit="handleFormSubmit(event)">
                                <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                    <h3 class="font-bold text-brand-900 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">IDENTITAS</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                        <div><label class="block text-sm font-semibold text-slate-700 mb-1">Nama Sales / PIC <span class="text-red-600">*</span></label><input type="text" id="input-sales" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500"></div>
                                        <div><label class="block text-sm font-semibold text-slate-700 mb-1">No HP Sales (WA) <span class="text-red-600">*</span></label><input type="text" id="input-phone-sales" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500"></div>
                                        <div><label class="block text-sm font-semibold text-slate-700 mb-1">Tanggal Laporan <span class="text-red-600">*</span></label><input type="date" id="input-date" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500"></div>
                                        <div class="md:col-span-1"><label class="block text-sm font-semibold text-slate-700 mb-1">Nama Customer / PT <span class="text-red-600">*</span></label><input type="text" id="input-customer" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500" placeholder="Ex. IVP / MLDS"></div>
                                        <div class="md:col-span-2"><label class="block text-sm font-semibold text-slate-700 mb-1">No PO / SPK <span class="text-red-600">*</span></label><input type="text" id="input-po" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500"></div>
                                    </div>
                                </div>

                                <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                    <h3 class="font-bold text-brand-900 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">DATA UNIT</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                        <div class="md:col-span-2"><label class="block text-sm font-semibold text-slate-700 mb-1">Tipe Produk / Model <span class="text-red-600">*</span></label><input type="text" id="input-product" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500"></div>
                                        <div class="md:col-span-2"><label class="block text-sm font-semibold text-slate-700 mb-1">Nama Project / Lokasi <span class="text-red-600">*</span></label><input type="text" id="input-project" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500"></div>
                                        <div class="md:col-span-2"><label class="block text-sm font-semibold text-slate-700 mb-1">Serial Number / Batch Modul</label><textarea id="input-batch" rows="3" class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500"></textarea></div>
                                        <div><label class="block text-sm font-semibold text-slate-700 mb-1">Jml. Unit Bermasalah <span class="text-red-600">*</span></label><input type="number" id="input-qty-bad" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500"></div>
                                    </div>
                                </div>

                                <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                    <h3 class="font-bold text-brand-900 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">DETAIL MASALAH</h3>
                                    <div class="space-y-5">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Kategori Masalah <span class="text-red-600">*</span></label>
                                            <select id="input-category" required class="w-full rounded border-slate-300 p-2.5 border bg-white focus:ring-brand-500"><option value="">-- Pilih --</option><option value="Dead Pixel">Dead Pixel / Lampu Mati</option><option value="Modul Error">Modul Error / Blok Warna</option><option value="Mati Total">Power Supply / Mati Total</option><option value="No Signal">No Signal / Receiving Card</option><option value="Fisik">Kerusakan Fisik / Pecah</option><option value="Software">Software / Config</option><option value="Lainnya">Lainnya</option></select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Kronologi <span class="text-red-600">*</span></label>
                                            <textarea id="input-chronology" required rows="4" class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                    <h3 class="font-bold text-brand-900 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">BUKTI DOKUMENTASI</h3>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Bukti Foto/Video (Max 5MB) <span class="text-red-600">*</span></label>
                                        <div id="upload-area" class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-white hover:border-brand-300 transition cursor-pointer relative" onclick="document.getElementById('input-evidence').click()">
                                            <input type="file" id="input-evidence" accept="image/*,video/*" multiple class="hidden" onchange="handleFileSelect(this)">
                                            <div id="upload-placeholder" class="space-y-2">
                                                <div class="mx-auto h-12 w-12 text-slate-300"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></div>
                                                <div class="text-sm text-slate-500 font-medium">Klik untuk upload foto/video</div>
                                            </div>
                                        </div>
                                        <div id="preview-container" class="hidden mt-4"></div>
                                    </div>
                                </div>
                                <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                    <h3 class="font-bold text-brand-900 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">TINDAK LANJUT</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                        <div><label class="block text-sm font-semibold text-slate-700 mb-1">Tanggal Kebutuhan Unit</label><input type="date" id="input-need-date" class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500"></div>
                                        <div><label class="block text-sm font-semibold text-slate-700 mb-1">Estimasi Unit Dikembalikan</label><input type="date" id="input-return-date" class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500"></div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Request Customer <span class="text-red-600">*</span></label>
                                            <select id="input-request" required class="w-full rounded border-slate-300 p-2.5 border bg-white mb-2 focus:ring-brand-500"><option value="Service On-site">Kunjungan Teknisi</option><option value="Sparepart">Kirim Sparepart</option><option value="Replace Unit">Ganti Unit Baru</option><option value="Remote">Bantuan Remote</option></select>
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Tingkat Urgensi (1-5)</label>
                                            <input id="input-urgency" type="range" min="1" max="5" value="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-brand-600">
                                            <div class="text-center text-xs font-bold text-brand-700 mt-1">Level: <span id="urgency-val">1</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-end gap-3 pt-4">
                                    <button type="button" onclick="if(isAdmin) switchTab('dashboard')" class="px-6 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors">Batal</button>
                                    <button type="submit" id="btn-submit" class="px-6 py-2.5 rounded-lg text-sm font-medium bg-brand-900 text-white hover:bg-brand-800 shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center justify-center min-w-[140px]"><span>Kirim Laporan</span></button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="bg-brand-50 p-6 rounded-xl border border-brand-100 sticky top-24">
                            <div class="flex items-center gap-2 mb-3"><span class="text-xl">üí°</span><h3 class="font-bold text-brand-900">Info Penting</h3></div>
                            <p class="text-sm text-brand-700 mb-4 leading-relaxed">Pastikan <strong>Serial Number</strong> tercatat untuk klaim garansi.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- FOOTER VERSION INDICATOR -->
    <footer class="text-center py-4 text-[10px] text-slate-400 bg-white border-t border-slate-100 mt-8">
        Versi: 2.3 (Final) - <span id="last-updated">Last Updated</span>
    </footer>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzZlUqREcW7N1TJW6k-6e_ZxBBtKKIm3orvJ0OUKA8_b0xSX6zcIlGXzu66-hWqCruP8w/exec"; 
        const ADMIN_KEYWORDS = ['admin', 'qc', 'boss', 'spv', 'manager']; 
        let isAdmin = false;
        let currentUser = "";
        let selectedFiles = []; 
        let allReports = [];
        let currentEditingId = null;

        // PAGINATION STATE
        const ROWS_QUEUE = 5;
        const ROWS_HISTORY = 10;
        let pageQueue = 1;
        let pageHistory = 1;

        // Set Last Updated Text
        document.getElementById('last-updated').innerText = new Date().toLocaleString();

        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('mv_user');
            if (savedUser) {
                const email = savedUser;
                if (ADMIN_KEYWORDS.some(role => email.includes(role))) {
                    isAdmin = true;
                    document.getElementById('nav-dashboard').classList.remove('hidden');
                    document.getElementById('btn-login-trigger').classList.add('hidden');
                    document.getElementById('user-panel').classList.remove('hidden');
                    document.getElementById('role-display').innerText = "Administrator";
                    document.getElementById('user-display').innerText = email.split('@')[0];
                    fetchData(); 
                }
            }
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-date').value = today;
        });

        function showLogin() { document.getElementById('login-overlay').classList.remove('hidden'); }
        function hideLogin() { document.getElementById('login-overlay').classList.add('hidden'); }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.toLowerCase();
            hideLogin();
            if (ADMIN_KEYWORDS.some(role => email.includes(role))) {
                isAdmin = true;
                localStorage.setItem('mv_user', email);
                document.getElementById('nav-dashboard').classList.remove('hidden');
                document.getElementById('btn-login-trigger').classList.add('hidden');
                document.getElementById('user-panel').classList.remove('hidden');
                document.getElementById('role-display').innerText = "Administrator";
                document.getElementById('user-display').innerText = email.split('@')[0];
                switchTab('dashboard'); 
                fetchData(); 
            } else {
                alert("Akses Dashboard ditolak.");
            }
        }

        function logout() { localStorage.removeItem('mv_user'); location.reload(); }

        function switchTab(tabName) {
            const dashboard = document.getElementById('dashboard-view');
            const form = document.getElementById('form-view');
            const btnDash = document.getElementById('nav-dashboard');
            const btnForm = document.getElementById('nav-form');
            if (tabName === 'dashboard') {
                if (!isAdmin) return; 
                dashboard.classList.remove('hidden');
                form.classList.add('hidden');
                btnDash.classList.add('bg-brand-50', 'text-brand-600', 'border-brand-100');
                btnForm.classList.remove('bg-brand-50', 'text-brand-600', 'border-brand-100');
                fetchData(); 
            } else {
                dashboard.classList.add('hidden');
                form.classList.remove('hidden');
                btnForm.classList.add('bg-brand-50', 'text-brand-600', 'border-brand-100');
                btnDash.classList.remove('bg-brand-50', 'text-brand-600', 'border-brand-100');
            }
        }

        async function fetchData() {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?t=${new Date().getTime()}`, { redirect: "follow" }); 
                const data = await response.json();
                allReports = data;
                applyFilters(); 
            } catch (error) {
                console.error("Fetch Error:", error);
            }
        }

        function applyFilters() {
            const monthEl = document.getElementById('filter-month');
            const yearEl = document.getElementById('filter-year');
            const searchEl = document.getElementById('search-input');
            const statusEl = document.getElementById('filter-status');
            
            const month = monthEl ? monthEl.value : 'all';
            const year = yearEl ? yearEl.value : 'all';
            const search = searchEl ? searchEl.value.toLowerCase() : '';
            const status = statusEl ? statusEl.value : 'all';

            let filtered = allReports;

            if (month !== 'all' || year !== 'all') {
                filtered = filtered.filter(row => {
                    if (!row.Date) return false;
                    const d = new Date(row.Date);
                    const m = d.getMonth().toString();
                    const y = d.getFullYear().toString();
                    const matchMonth = (month === 'all') || (m === month);
                    const matchYear = (year === 'all') || (y === year);
                    return matchMonth && matchYear;
                });
            }

            if (search) {
                filtered = filtered.filter(row => 
                    (row.PO && String(row.PO).toLowerCase().includes(search))
                );
            }

            if (status !== 'all') {
                filtered = filtered.filter(row => row.Status === status);
            }
            
            const isSearching = search.trim() !== '';
            renderDashboard(filtered, isSearching);
        }

        function renderDashboard(data, isSearch = false) {
            if(!isSearch) {
                document.getElementById('total-reports').innerText = data.length;
                const pendingCount = data.filter(r => r.Status === 'Pending' || r.Status === 'Open').length;
                document.getElementById('pending-reports').innerText = pendingCount;
                document.getElementById('closed-reports').innerText = data.filter(r => r.Status === 'Closed').length;

                const total = data.length || 1;
                document.getElementById('bar-pending').style.width = `${(pendingCount/total)*100}%`;
                document.getElementById('bar-closed').style.width = `${(data.filter(r => r.Status === 'Closed').length/total)*100}%`;
                updateCharts(data);
            }
            
            const pendingData = data.filter(r => r.Status === 'Pending' || r.Status === 'Open');
            const closedData = data.filter(r => r.Status === 'Closed');

            renderQueueTable(pendingData);
            renderHistoryTable(closedData);
        }

        function renderQueueTable(data) {
            const tableBody = document.getElementById('case-table-body');
            tableBody.innerHTML = '';
            
            const sortedData = [...data].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
            
            const totalPages = Math.ceil(sortedData.length / ROWS_QUEUE);
            if (pageQueue > totalPages) pageQueue = totalPages || 1;
            
            const start = (pageQueue - 1) * ROWS_QUEUE;
            const end = start + ROWS_QUEUE;
            const pageData = sortedData.slice(start, end);

            if (pageData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-slate-400 italic">Tidak ada antrian pending.</td></tr>';
            } else {
                pageData.forEach(row => {
                    let dateStr = '-';
                    let agingText = '-';
                    let agingClass = 'text-slate-500';

                    if(row.Date) {
                        const d = new Date(row.Date);
                        const now = new Date();
                        if(!isNaN(d.getTime())) {
                            dateStr = d.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
                            const diffTime = Math.abs(now - d);
                            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
                            
                            if (diffDays == 0) { agingText = "Hari Ini"; agingClass = "aging-new"; }
                            else if (diffDays <= 3) { agingText = `${diffDays} Hari`; agingClass = "aging-new"; }
                            else if (diffDays <= 7) { agingText = `${diffDays} Hari`; agingClass = "aging-med"; }
                            else { agingText = `‚ö†Ô∏è ${diffDays} Hari`; agingClass = "aging-old"; }
                        }
                    }

                    let evidenceContent = '<span class="text-slate-400">-</span>';
                    if (row.Evidence && row.Evidence.startsWith('http')) {
                        evidenceContent = `<a href="${row.Evidence}" target="_blank" class="text-blue-600 font-bold hover:underline text-xs">Lihat</a>`;
                    }

                    const tr = document.createElement('tr');
                    tr.className = "bg-white border-b hover:bg-slate-50 transition";
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-slate-500 text-left">${dateStr}</td>
                        <td class="px-6 py-4 text-left font-semibold text-brand-600">${row.PO || '-'}</td>
                        <td class="px-6 py-4 text-left"><div class="text-sm font-bold text-slate-800">${row.Project || '-'}</div></td>
                        <td class="px-6 py-4 text-slate-600 text-left">${row.Sales}</td>
                        <td class="px-6 py-4 text-left"><div class="text-sm font-medium text-slate-800">${row.Category}</div><div class="text-xs text-slate-500 truncate max-w-[150px]">${row.Chronology}</div></td>
                        <td class="px-6 py-4 text-center">${evidenceContent}</td>
                        <td class="px-6 py-4 text-center"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-pending">Pending</span></td>
                        <td class="px-6 py-4 text-center text-xs ${agingClass}">${agingText}</td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="openDetailModal('${row.id}')" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded-md border border-slate-300 font-medium transition flex items-center gap-1 mx-auto">
                            Detail
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            const paginationDiv = document.getElementById('queue-pagination');
            paginationDiv.innerHTML = '';
            if (totalPages > 1) {
                const prev = document.createElement('button');
                prev.innerHTML = 'Prev';
                prev.className = 'px-2 py-1 text-xs border rounded hover:bg-slate-50';
                prev.disabled = pageQueue === 1;
                prev.onclick = () => { if(pageQueue > 1) { pageQueue--; renderQueueTable(data); }};
                paginationDiv.appendChild(prev);

                const span = document.createElement('span');
                span.innerText = ` ${pageQueue} / ${totalPages} `;
                span.className = 'px-2 py-1 text-xs';
                paginationDiv.appendChild(span);

                const next = document.createElement('button');
                next.innerHTML = 'Next';
                next.className = 'px-2 py-1 text-xs border rounded hover:bg-slate-50';
                next.disabled = pageQueue === totalPages;
                next.onclick = () => { if(pageQueue < totalPages) { pageQueue++; renderQueueTable(data); }};
                paginationDiv.appendChild(next);
            }
        }

        function renderHistoryTable(data) {
            const tableBody = document.getElementById('history-table-body');
            tableBody.innerHTML = '';
            
            const sortedData = [...data].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
            
            const totalPages = Math.ceil(sortedData.length / ROWS_HISTORY);
            if (pageHistory > totalPages) pageHistory = totalPages || 1;
            
            const start = (pageHistory - 1) * ROWS_HISTORY;
            const end = start + ROWS_HISTORY;
            const pageData = sortedData.slice(start, end);

            if (pageData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-slate-400">Tidak ada histori.</td></tr>';
            } else {
                pageData.forEach(row => {
                    let dateStr = row.Date ? new Date(row.Date).toLocaleDateString('id-ID') : '-';
                    const tr = document.createElement('tr');
                    tr.className = "bg-white border-b hover:bg-slate-50";
                    tr.innerHTML = `
                        <td class="px-6 py-3 whitespace-nowrap text-slate-500">${dateStr}</td>
                        <td class="px-6 py-3 font-medium text-slate-800">${row.PO || '-'}</td>
                        <td class="px-6 py-3">${row.Project || '-'}</td>
                        <td class="px-6 py-3 text-slate-600">${row.Sales}</td>
                        <td class="px-6 py-3 truncate max-w-[150px]" title="${row.Category}">${row.Category}</td>
                        <td class="px-6 py-3 text-center"><span class="text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded">Closed</span></td>
                        <td class="px-6 py-3 text-center">
                            <button onclick="openDetailModal('${row.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-bold">Detail</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            const paginationDiv = document.getElementById('history-pagination');
            paginationDiv.innerHTML = '';
            if (totalPages > 1) {
                 const prev = document.createElement('button');
                 prev.innerHTML = 'Prev';
                 prev.className = 'px-2 py-1 text-xs border rounded hover:bg-slate-50';
                 prev.disabled = pageHistory === 1;
                 prev.onclick = () => { if(pageHistory > 1) { pageHistory--; renderHistoryTable(data); }};
                 paginationDiv.appendChild(prev);

                 const span = document.createElement('span');
                 span.innerText = ` ${pageHistory} / ${totalPages} `;
                 span.className = 'px-2 py-1 text-xs';
                 paginationDiv.appendChild(span);

                 const next = document.createElement('button');
                 next.innerHTML = 'Next';
                 next.className = 'px-2 py-1 text-xs border rounded hover:bg-slate-50';
                 next.disabled = pageHistory === totalPages;
                 next.onclick = () => { if(pageHistory < totalPages) { pageHistory++; renderHistoryTable(data); }};
                 paginationDiv.appendChild(next);
            }
        }

        function openDetailModal(id) {
            const row = allReports.find(r => r.id == id);
            if(!row) return;

            currentEditingId = id;
            document.getElementById('modal-id').innerText = `ID: ${id}`;
            document.getElementById('modal-display-po').value = row.PO || '-'; 
            document.getElementById('modal-date').value = row.Date ? new Date(row.Date).toLocaleDateString() : '-';
            
            let phone = '-';
            let salesName = row.Sales;
            
            if(row.Sales && row.Sales.includes('[')) {
                const phoneMatch = row.Sales.match(/\[(.*?)\]/);
                if (phoneMatch && phoneMatch[1]) {
                     phone = phoneMatch[1];
                     salesName = row.Sales.replace(phoneMatch[0], '').trim();
                }
            } else if (row.PhoneSales) {
                 phone = row.PhoneSales;
            }

            document.getElementById('modal-sales').value = salesName;
            document.getElementById('modal-sales-phone').value = phone;
            
            const waBtn = document.getElementById('btn-wa-sales');
            if (phone && phone !== '-' && phone.length > 5) {
                let cleanPhone = phone.replace(/\D/g, '');
                if (cleanPhone.startsWith('0')) {
                    cleanPhone = '62' + cleanPhone.substring(1);
                }
                const msg = encodeURIComponent(`Halo ${salesName}, Update untuk case ${row.PO} (Customer: ${row.Customer}): Status sekarang ${row.Status}.`);
                waBtn.href = `https://wa.me/${cleanPhone}?text=${msg}`;
                waBtn.classList.remove('hidden');
            } else {
                waBtn.classList.add('hidden');
            }

            document.getElementById('modal-customer').value = row.Customer;
            document.getElementById('modal-project').value = row.Project;
            document.getElementById('modal-product').value = row.Product;
            document.getElementById('modal-batch').value = row.Batch || "-";

            document.getElementById('modal-issue').value = row.Category;
            document.getElementById('modal-request').value = row.Request || "-";
            document.getElementById('modal-chronology').value = row.Chronology;
            
            const evidenceContainer = document.getElementById('modal-evidence');
            if (row.Evidence && row.Evidence.startsWith('http')) {
                // If there are multiple files (comma separated)
                const urls = row.Evidence.split(',').map(url => url.trim());
                let html = '<div class="flex flex-wrap gap-2">';
                urls.forEach(url => {
                     html += `<a href="${url}" target="_blank" class="text-blue-600 hover:underline flex items-center gap-1 text-xs bg-blue-50 px-2 py-1 rounded border border-blue-100">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg> Lihat File
                     </a>`;
                });
                html += '</div>';
                evidenceContainer.innerHTML = html;
            } else {
                evidenceContainer.innerHTML = '<span class="text-slate-400">Tidak ada file</span>';
            }

            let currentStatus = row.Status;
            if(currentStatus === 'Open') currentStatus = 'Pending';
            document.getElementById('modal-status-select').value = currentStatus || 'Pending';
            
            document.getElementById('modal-admin-notes').value = row.AdminNotes || "";
            document.getElementById('modal-ref-po').value = row.PO || "";
            document.getElementById('modal-update-date').value = new Date().toISOString().split('T')[0];

            const inputs = document.querySelectorAll('.input-readonly');
            inputs.forEach(el => {
                el.readOnly = true;
                el.classList.remove('input-editable');
                el.classList.add('input-readonly');
            });
            document.getElementById('edit-actions').classList.add('hidden');
            document.getElementById('btn-edit-toggle').classList.remove('hidden');

            toggleAdminFields();
            document.body.classList.add('modal-open'); // Lock scroll
            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.body.classList.remove('modal-open'); // Unlock scroll
            document.getElementById('detail-modal').classList.add('hidden');
            currentEditingId = null;
        }

        function toggleEditMode() {
            const inputs = document.querySelectorAll('.input-readonly');
            inputs.forEach(el => {
                el.readOnly = false;
                el.classList.remove('input-readonly');
                el.classList.add('input-editable');
            });
            document.getElementById('edit-actions').classList.remove('hidden');
            document.getElementById('btn-edit-toggle').classList.add('hidden');
        }

        function cancelEditMode() {
            openDetailModal(currentEditingId);
        }

        async function saveDataEdit() {
           const id = currentEditingId;
           const updatedData = {
               id: id,
               sales: document.getElementById('modal-sales').value,
               customer: document.getElementById('modal-customer').value,
               po: document.getElementById('modal-display-po').value,
               product: document.getElementById('modal-product').value,
               batch: document.getElementById('modal-batch').value,
               project: document.getElementById('modal-project').value,
               chronology: document.getElementById('modal-chronology').value,
               request: document.getElementById('modal-request').value
           };
           
           const btn = document.getElementById('btn-save-data');
           const originalText = btn.innerHTML;
           btn.innerHTML = `<div class="spinner w-3 h-3 border-white border-2 rounded-full animate-spin"></div>`;
           btn.disabled = true;

           const payload = {
               action: 'edit_full_data',
               data: updatedData
           };

           try {
               await fetch(GOOGLE_SCRIPT_URL, {
                   method: 'POST',
                   mode: 'no-cors',
                   headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                   body: JSON.stringify(payload)
               });
               
               const row = allReports.find(r => r.id == id);
               if(row) {
                   row.Sales = updatedData.sales;
                   row.Customer = updatedData.customer;
                   row.PO = updatedData.po;
                   row.Product = updatedData.product;
                   row.Batch = updatedData.batch;
                   row.Project = updatedData.project;
                   row.Chronology = updatedData.chronology;
                   row.Request = updatedData.request;
               }
               
               showToast("Data Berhasil Diubah");
               openDetailModal(id);
               renderDashboard(allReports);
           } catch(e) {
               alert("Gagal menyimpan data: " + e.message);
               btn.innerHTML = originalText;
               btn.disabled = false;
           }
        }

        function toggleAdminFields() {
            const status = document.getElementById('modal-status-select').value;
            const fieldsContainer = document.getElementById('admin-fields-container');
            const placeholder = document.getElementById('pending-placeholder');
            
            if (status === 'Closed') {
                fieldsContainer.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                fieldsContainer.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }

        async function saveCaseUpdate() {
            if(!currentEditingId) return;

            const newStatus = document.getElementById('modal-status-select').value;
            const newNotes = document.getElementById('modal-admin-notes').value;
            
            const btn = document.getElementById('btn-save-update');
            const originalText = btn.innerHTML;

            btn.innerHTML = `<div class="spinner mr-2"></div> Menyimpan...`;
            btn.disabled = true;

            const payload = {
                action: 'update_case',
                id: currentEditingId,
                status: newStatus,
                notes: newNotes
            };

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                
                const row = allReports.find(r => r.id == currentEditingId);
                if(row) {
                    row.Status = newStatus;
                    row.AdminNotes = newNotes;
                }
                
                showToast("Status Berhasil di Update");

                closeDetailModal();
                renderDashboard(allReports);
                setTimeout(fetchData, 2000);
            } catch(e) {
                alert("Gagal update: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function showToast(message = "Data berhasil disimpan.") {
            const toast = document.getElementById('toast-notification');
            const msgEl = document.getElementById('toast-message');
            msgEl.innerText = message;
            
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.remove('translate-x-full', 'opacity-0'), 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 500);
            }, 3000);
        }

        function handleFileSelect(input) {
            if (input.files && input.files.length > 0) {
                let totalSize = 0;
                for (let f of selectedFiles) totalSize += f.size;
                for (let f of input.files) totalSize += f.size;
                
                if (totalSize > 5 * 1024 * 1024) { 
                    alert("Total ukuran file tidak boleh lebih dari 5MB!");
                    return;
                }

                Array.from(input.files).forEach(file => {
                     selectedFiles.push(file);
                });
                
                renderPreviews();
                input.value = ''; 
            }
        }
        
        function renderPreviews() {
            const container = document.getElementById('preview-container');
            const uploadArea = document.getElementById('upload-area');
            
            if (selectedFiles.length === 0) {
                container.classList.add('hidden');
                uploadArea.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            uploadArea.classList.add('hidden');
            
            let html = '<div class="grid grid-cols-3 gap-2">';
            selectedFiles.forEach((file, index) => {
                const url = URL.createObjectURL(file);
                const isImg = file.type.startsWith('image/');
                html += `
                    <div class="relative aspect-square rounded-lg overflow-hidden border border-slate-200 group">
                        ${isImg ? `<img src="${url}" class="w-full h-full object-cover">` : `<video src="${url}" class="w-full h-full object-cover"></video>`}
                        <button onclick="removeFile(${index})" type="button" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">√ó</button>
                    </div>
                `;
            });
            html += `
                <div onclick="document.getElementById('input-evidence').click()" class="aspect-square rounded-lg border-2 border-dashed border-slate-300 flex flex-col items-center justify-center text-slate-400 cursor-pointer hover:bg-slate-50 transition">
                    <span class="text-2xl">+</span>
                    <span class="text-[10px]">Tambah</span>
                </div>
            `;
            html += '</div>';
            
            container.innerHTML = html;
        }

        function removeFile(index) {
            if(event) event.stopPropagation();
            selectedFiles.splice(index, 1);
            renderPreviews();
        }

        const getBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); 
                reader.onerror = error => reject(error);
            });
        };

        async function handleFormSubmit(event) {
            event.preventDefault();
            const btn = document.getElementById('btn-submit');
            const originalText = btn.innerText;
            btn.innerHTML = `<div class="spinner mr-2"></div> Mengirim...`;
            btn.disabled = true;

            if (selectedFiles.length === 0) { alert("Wajib upload bukti!"); btn.innerHTML = originalText; btn.disabled = false; return; }

            let filesData = [];
            try {
                const filePromises = selectedFiles.map(file => getBase64(file).then(content => ({
                    name: file.name,
                    type: file.type,
                    content: content
                })));
                filesData = await Promise.all(filePromises);
            } catch (e) { alert("Gagal proses file"); btn.innerHTML = originalText; btn.disabled = false; return; }

            const name = document.getElementById('input-sales').value;
            const phone = document.getElementById('input-phone-sales').value;
            const salesCombined = `${name} [${phone}]`;

            const formData = {
                sales: salesCombined, 
                date: document.getElementById('input-date').value,
                customer: document.getElementById('input-customer').value,
                po: document.getElementById('input-po').value,
                product: document.getElementById('input-product').value,
                batch: document.getElementById('input-batch').value,
                project: document.getElementById('input-project').value, 
                qtyBad: document.getElementById('input-qty-bad').value,
                category: document.getElementById('input-category').value,
                chronology: document.getElementById('input-chronology').value,
                request: document.getElementById('input-request').value,
                urgency: document.getElementById('input-urgency').value,
                needDate: document.getElementById('input-need-date').value,
                returnDate: document.getElementById('input-return-date').value,
                files: filesData 
            };

            const payload = { action: 'insert', data: formData };

            if (GOOGLE_SCRIPT_URL) {
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                })
                .then(() => {
                    showToast("Data berhasil disimpan.");
                    event.target.reset();
                    selectedFiles = []; 
                    renderPreviews(); 
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    if(isAdmin) { switchTab('dashboard'); setTimeout(fetchData, 2000); }
                })
                .catch(err => { alert("Gagal kirim."); btn.innerHTML = originalText; btn.disabled = false; });
            }
        }

        function downloadExcel() {
            if (!allReports || allReports.length === 0) return alert("Belum ada data.");
            const headers = Object.keys(allReports[0]);
            const csvRows = [headers.join(',')];
            for (const row of allReports) {
                const values = headers.map(header => {
                    const escaped = ('' + row[header]).replace(/"/g, '\\"'); 
                    return `"${escaped}"`; 
                });
                csvRows.push(values.join(','));
            }
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'laporan_qc_microvision.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function updateCharts(data) {
            const catCounts = {};
            const urgCounts = [0,0,0,0,0]; 
            data.forEach(r => {
                const cat = r.Category || 'Lainnya';
                catCounts[cat] = (catCounts[cat] || 0) + 1;
                const urg = parseInt(r.Urgency);
                if(urg >=1 && urg <=5) urgCounts[urg-1]++;
            });

            const monthCounts = Array(12).fill(0);
            data.forEach(r => {
                if (r.Date) {
                    const d = new Date(r.Date);
                    if (!isNaN(d.getTime())) {
                        monthCounts[d.getMonth()]++;
                    }
                }
            });
            const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];

            Chart.register(ChartDataLabels); 

            if(window.catChart) window.catChart.destroy();
            window.catChart = new Chart(document.getElementById('categoryChart').getContext('2d'), {
                type: 'bar',
                data: { labels: Object.keys(catCounts), datasets: [{ label: 'Jumlah', data: Object.values(catCounts), backgroundColor: '#0ea5e9' }] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    layout: { padding: { top: 40 } }, 
                    plugins: { 
                        legend: {display: false},
                        title: { display: true, text: 'Kasus Terbanyak Berdasarkan Kategori', padding: { bottom: 30 }, font: { size: 14 } },
                        datalabels: {
                            color: 'white', 
                            anchor: 'end',
                            align: 'start', 
                            font: { weight: 'bold' }
                        }
                    } 
                }
            });

            if(window.urgChart) window.urgChart.destroy();
            window.urgChart = new Chart(document.getElementById('urgencyChart').getContext('2d'), {
                type: 'line', 
                data: { 
                    labels: monthLabels, 
                    datasets: [{ 
                        label: 'Total Kasus', 
                        data: monthCounts, 
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        fill: true,
                        tension: 0.4
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    layout: { padding: { top: 40 } }, 
                    plugins: {
                        title: { display: true, text: 'Tren Kasus Per Bulan', padding: { bottom: 30 }, font: { size: 14 } },
                        datalabels: {
                            color: 'black', 
                            anchor: 'end',
                            align: 'top', 
                            offset: 5,
                            font: { weight: 'bold' }
                        }
                    }
                }
            });
        }
        
        document.getElementById('input-urgency').addEventListener('input', function(e) { document.getElementById('urgency-val').innerText = e.target.value; });
    </script>
</body>
</html>

