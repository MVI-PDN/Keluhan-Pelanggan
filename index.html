<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microvision QC System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 800: '#075985', 900: '#0c4a6e' },
                        ai: { 50: '#f5f3ff', 100: '#ede9fe', 600: '#7c3aed', 700: '#6d28d9' }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .ai-pulse { animation: pulse-purple 2s infinite; }
        @keyframes pulse-purple { 0% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(124, 58, 237, 0); } 100% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0); } }
        
        /* Login Overlay */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans leading-relaxed overflow-x-hidden">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay">
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-200 max-w-md w-full text-center">
            <div class="bg-brand-600 text-white w-16 h-16 rounded-full flex items-center justify-center text-3xl font-bold mx-auto mb-6">M</div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Selamat Datang</h2>
            <p class="text-slate-500 mb-6 text-sm">Silakan masukkan email kerja Anda untuk mengakses sistem.</p>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="email" id="login-email" required placeholder="nama@microvision.com" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-brand-500 outline-none">
                <button type="submit" class="w-full bg-brand-600 text-white py-3 rounded-lg font-bold hover:bg-brand-700 transition">Masuk Sistem</button>
            </form>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm hidden" id="main-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-brand-600 text-white p-2 rounded-lg font-bold text-xl tracking-tighter">M</div>
                    <div>
                        <h1 class="font-bold text-slate-900 text-xl leading-tight italic tracking-wide">Microvision</h1>
                        <p class="text-xs text-slate-500 tracking-wider">Realizing Your full Idea</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 md:space-x-4">
                    <!-- Dashboard Button (Hidden for non-admins) -->
                    <button onclick="switchTab('dashboard')" id="nav-dashboard" class="hidden px-4 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors">
                        Dashboard
                    </button>
                    <button onclick="switchTab('form')" id="nav-form" class="px-4 py-2 rounded-md text-sm font-medium bg-brand-50 text-brand-600 border border-brand-100 transition-colors shadow-sm">
                        Laporan Baru
                    </button>
                    <div class="text-xs text-right border-l pl-3 ml-2">
                        <span class="block font-bold text-slate-700" id="user-display">User</span>
                        <span class="text-slate-400 cursor-pointer hover:text-red-500" onclick="logout()">Logout</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden" id="main-content">

        <!-- DASHBOARD VIEW -->
        <section id="dashboard-view" class="hidden space-y-8 fade-in">
            <div class="flex justify-between items-center bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Quality Control Dashboard</h2>
                    <p class="text-slate-600 text-sm">Data Real-time dari Google Sheets.</p>
                </div>
                <button onclick="fetchData()" class="text-sm bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-2 rounded-lg transition flex items-center gap-2">
                    üîÑ Refresh Data
                </button>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">Total Kasus</h3>
                    <span class="text-3xl font-bold text-brand-600" id="total-reports">Loading...</span>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">Kasus Pending/Open</h3>
                    <span class="text-3xl font-bold text-orange-500" id="pending-reports">Loading...</span>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">Kasus Closed</h3>
                    <span class="text-3xl font-bold text-green-600" id="closed-reports">Loading...</span>
                </div>
            </div>

            <!-- Case Queue List (NEW FEATURE) -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-6 border-b border-slate-100">
                    <h3 class="font-bold text-lg text-slate-800">üìã Antrian Kasus (Live Queue)</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                            <tr>
                                <th class="px-6 py-3">Tanggal</th>
                                <th class="px-6 py-3">Sales / PIC</th>
                                <th class="px-6 py-3">Project / Lokasi</th>
                                <th class="px-6 py-3">Masalah</th>
                                <th class="px-6 py-3">Status</th>
                                <th class="px-6 py-3">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="case-table-body">
                            <tr><td colspan="6" class="px-6 py-4 text-center">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Distribusi Kategori</h3>
                    <div class="chart-container"><canvas id="categoryChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Urgency Trend</h3>
                    <div class="chart-container"><canvas id="urgencyChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- FORM VIEW -->
        <section id="form-view" class="hidden fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Formulir Keluhan Baru</h2>
                        <p class="text-slate-600 mb-6 text-sm">Lengkapi data teknis untuk analisis QC.</p>

                        <form id="complaintForm" class="space-y-8" onsubmit="handleFormSubmit(event)">
                            <!-- Bagian 1 -->
                            <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                <h3 class="font-bold text-brand-800 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">IDENTITAS</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Nama Sales / PIC *</label>
                                        <input type="text" id="input-sales" required class="w-full rounded border-slate-300 p-2.5 border">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Tanggal Laporan *</label>
                                        <input type="date" id="input-date" required class="w-full rounded border-slate-300 p-2.5 border">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Nama Customer / PT *</label>
                                        <input type="text" id="input-customer" required class="w-full rounded border-slate-300 p-2.5 border">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">No PO / Kontrak *</label>
                                        <input type="text" id="input-po" required class="w-full rounded border-slate-300 p-2.5 border">
                                    </div>
                                </div>
                            </div>

                            <!-- Bagian 2 -->
                            <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                <h3 class="font-bold text-brand-800 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">DATA UNIT</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Tipe Produk / Model *</label>
                                        <input type="text" id="input-product" required class="w-full rounded border-slate-300 p-2.5 border" placeholder="Ex: Videotron P2.5 Indoor">
                                    </div>
                                    <!-- CHANGE 4: Total Unit -> Project -->
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Nama Project / Lokasi *</label>
                                        <input type="text" id="input-project" required class="w-full rounded border-slate-300 p-2.5 border" placeholder="Ex: Ruang Rapat Lt. 3">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Serial Number / Batch Modul</label>
                                        <input type="text" id="input-batch" class="w-full rounded border-slate-300 p-2.5 border">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Jml. Unit Bermasalah *</label>
                                        <input type="number" id="input-qty-bad" required class="w-full rounded border-slate-300 p-2.5 border">
                                    </div>
                                </div>
                            </div>

                            <!-- Bagian 3 -->
                            <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                <h3 class="font-bold text-brand-800 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">DETAIL MASALAH</h3>
                                <div class="space-y-5">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Kategori Masalah *</label>
                                        <select id="input-category" required class="w-full rounded border-slate-300 p-2.5 border bg-white">
                                            <option value="">-- Pilih --</option>
                                            <option value="Dead Pixel">Dead Pixel / Lampu Mati</option>
                                            <option value="Modul Error">Modul Error / Blok Warna</option>
                                            <option value="Mati Total">Power Supply / Mati Total</option>
                                            <option value="No Signal">No Signal / Receiving Card</option>
                                            <option value="Fisik">Kerusakan Fisik / Pecah</option>
                                            <option value="Software">Software / Config</option>
                                            <option value="Lainnya">Lainnya</option>
                                        </select>
                                    </div>
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <label class="block text-sm font-semibold text-slate-700">Kronologi *</label>
                                            <button type="button" onclick="generateAnalysis()" class="text-xs bg-ai-100 text-ai-700 px-2 rounded hover:bg-ai-600 hover:text-white transition">‚ú® AI Analysis</button>
                                        </div>
                                        <textarea id="input-chronology" required rows="4" class="w-full rounded border-slate-300 p-2.5 border"></textarea>
                                        <div id="ai-analysis-result" class="hidden mt-2 bg-white border border-ai-600 rounded p-3 text-sm text-slate-700"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bagian 4 -->
                            <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                <h3 class="font-bold text-brand-800 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">TINDAK LANJUT</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div class="md:col-span-2">
                                        <div class="flex justify-between mb-1">
                                            <label class="block text-sm font-semibold text-slate-700">Request Customer *</label>
                                            <button type="button" onclick="generateReply()" class="text-xs bg-ai-100 text-ai-700 px-2 rounded hover:bg-ai-600 hover:text-white transition">‚ú® Draft WA</button>
                                        </div>
                                        <select id="input-request" required class="w-full rounded border-slate-300 p-2.5 border bg-white mb-2">
                                            <option value="Service On-site">Kunjungan Teknisi</option>
                                            <option value="Sparepart">Kirim Sparepart</option>
                                            <option value="Replace Unit">Ganti Unit Baru</option>
                                            <option value="Remote">Bantuan Remote</option>
                                        </select>
                                        <div id="ai-reply-result" class="hidden bg-green-50 border border-green-200 rounded p-3">
                                            <textarea id="reply-content" rows="4" class="w-full text-xs bg-transparent border-none resize-none" readonly></textarea>
                                        </div>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Urgensi (1-5)</label>
                                        <input id="input-urgency" type="range" min="1" max="5" value="3" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-brand-600">
                                        <div class="text-center text-xs font-bold text-brand-700">Level: <span id="urgency-val">3</span></div>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end gap-3">
                                <button type="button" onclick="if(isAdmin) switchTab('dashboard')" class="px-6 py-2 rounded text-slate-600 hover:bg-slate-100">Batal</button>
                                <button type="submit" class="px-6 py-2 rounded bg-brand-600 text-white hover:bg-brand-700 shadow-md">Kirim Laporan</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Side Panel Info -->
                <div class="lg:col-span-1">
                    <div class="bg-brand-50 p-6 rounded-xl border border-brand-100 sticky top-24">
                        <h3 class="font-bold text-brand-900 mb-2">üí° Info Penting</h3>
                        <p class="text-sm text-brand-700 mb-4">Pastikan SN/Batch tercatat untuk klaim garansi. Project/Lokasi membantu teknisi menemukan unit.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- LOGIC -->
    <script>
        // --- CONFIGURATION ---
        const apiKey = "AIzaSyC23J36bwT2FVDmsgQszP4CctH2yBAAE7w"; 
        // ‚ö†Ô∏è GANTI INI DENGAN URL DEPLOYMENT GOOGLE SCRIPT TERBARU ANDA
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzHvMmtWCjLHDUaub9jnf_DTX0EmRWy7l65SLEAVpUee_IC8WRfHnnKkSrDLQjSPk_VUQ/exec"; 
        
        // --- AUTH CONFIG ---
        // Daftar email yang boleh melihat Dashboard (Admin/QC)
        const ALLOWED_ADMINS = ['admin@microvision.com', 'qc@microvision.com', 'boss@microvision.com'];
        let isAdmin = false;
        let currentUser = "";

        // --- AUTH FUNCTIONS ---
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.toLowerCase();
            currentUser = email;
            
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-nav').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('user-display').innerText = email;

            // Simple Logic: Check if email contains 'admin' or 'qc' or is in list
            if (ALLOWED_ADMINS.includes(email) || email.includes('admin') || email.includes('qc')) {
                isAdmin = true;
                document.getElementById('nav-dashboard').classList.remove('hidden');
                switchTab('dashboard'); // Admin masuk ke Dashboard
                fetchData(); // Load data from Sheet
            } else {
                isAdmin = false;
                switchTab('form'); // Sales hanya ke Form
            }
        }

        function logout() {
            location.reload();
        }

        // --- NAVIGATION ---
        function switchTab(tabName) {
            const dashboard = document.getElementById('dashboard-view');
            const form = document.getElementById('form-view');
            const btnDash = document.getElementById('nav-dashboard');
            const btnForm = document.getElementById('nav-form');

            if (tabName === 'dashboard') {
                if (!isAdmin) return; // Prevent access logic
                dashboard.classList.remove('hidden');
                form.classList.add('hidden');
                btnDash.className = "px-4 py-2 rounded-md text-sm font-medium bg-brand-50 text-brand-600 border border-brand-100 transition-colors shadow-sm";
                btnForm.className = "px-4 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors";
            } else {
                dashboard.classList.add('hidden');
                form.classList.remove('hidden');
                btnForm.className = "px-4 py-2 rounded-md text-sm font-medium bg-brand-50 text-brand-600 border border-brand-100 transition-colors shadow-sm";
                btnDash.className = "px-4 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors";
                // Set default date
                document.getElementById('input-date').valueAsDate = new Date();
            }
        }

        // --- DATA MANAGEMENT (READ & WRITE) ---
        let allReports = [];

        // 1. FETCH DATA (READ)
        async function fetchData() {
            if (!GOOGLE_SCRIPT_URL) return;
            
            const tableBody = document.getElementById('case-table-body');
            tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center">Sedang mengambil data dari Google Sheet...</td></tr>';

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL); // Default GET
                const data = await response.json();
                allReports = data;
                
                renderDashboard(allReports);
            } catch (error) {
                console.error("Fetch Error:", error);
                tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Gagal mengambil data. Cek koneksi atau URL Script.</td></tr>';
            }
        }

        // 2. RENDER DASHBOARD & LIST
        function renderDashboard(data) {
            // Metrics
            document.getElementById('total-reports').innerText = data.length;
            const pending = data.filter(r => r.Status !== 'Closed').length;
            document.getElementById('pending-reports').innerText = pending;
            document.getElementById('closed-reports').innerText = data.length - pending;

            // Table List (Sorted by Date Descending)
            const tableBody = document.getElementById('case-table-body');
            tableBody.innerHTML = '';
            
            // Sort: Terbaru di atas
            const sortedData = [...data].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));

            sortedData.forEach(row => {
                // Determine ID key (Sheet headers might vary case)
                const id = row.ID || row.id || row['ID (Baru)'] || row[Object.keys(row)[0]]; 
                const statusColor = row.Status === 'Closed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                
                // Format Date nicely
                let dateStr = row.Tanggal || row.Date;
                if (dateStr && new Date(dateStr) !== "Invalid Date") {
                    dateStr = new Date(dateStr).toLocaleDateString('id-ID');
                }

                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-slate-50";
                tr.innerHTML = `
                    <td class="px-6 py-4">${dateStr}</td>
                    <td class="px-6 py-4 font-medium text-slate-900">${row.Sales}</td>
                    <td class="px-6 py-4">${row.Project || row['Total Qty'] || '-'}</td>
                    <td class="px-6 py-4">
                        <span class="font-bold block text-xs uppercase text-slate-500">${row.Kategori}</span>
                        ${row.Produk}
                    </td>
                    <td class="px-6 py-4">
                        <span class="${statusColor} text-xs font-medium px-2.5 py-0.5 rounded">${row.Status || 'Pending'}</span>
                    </td>
                    <td class="px-6 py-4">
                        ${row.Status !== 'Closed' ? 
                            `<button onclick="updateStatus('${id}', 'Closed')" class="text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">Close Case</button>` : 
                            `<button onclick="updateStatus('${id}', 'Pending')" class="text-xs bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">Re-Open</button>`
                        }
                    </td>
                `;
                tableBody.appendChild(tr);
            });

            updateCharts(data);
        }

        // 3. UPDATE STATUS (EDIT)
        async function updateStatus(id, newStatus) {
            if(!confirm(`Ubah status kasus ini menjadi ${newStatus}?`)) return;

            const payload = {
                action: 'update_status',
                id: id,
                status: newStatus
            };

            // Optimistic UI Update (Update tampilan dulu biar cepat)
            const row = allReports.find(r => (r.ID || r[Object.keys(r)[0]]) == id);
            if(row) {
                row.Status = newStatus;
                renderDashboard(allReports);
            }

            // Send to Backend
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });
                // Fetch real data again after delay
                setTimeout(fetchData, 2000); 
            } catch(e) {
                alert("Gagal update status di server");
            }
        }

        // 4. SUBMIT FORM (CREATE)
        function handleFormSubmit(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button[type="submit"]');
            btn.innerText = "Mengirim...";
            btn.disabled = true;

            const formData = {
                sales: document.getElementById('input-sales').value,
                date: document.getElementById('input-date').value,
                customer: document.getElementById('input-customer').value,
                po: document.getElementById('input-po').value,
                product: document.getElementById('input-product').value,
                batch: document.getElementById('input-batch').value,
                project: document.getElementById('input-project').value, // NEW FIELD
                qtyBad: document.getElementById('input-qty-bad').value,
                category: document.getElementById('input-category').value,
                chronology: document.getElementById('input-chronology').value,
                request: document.getElementById('input-request').value,
                urgency: document.getElementById('input-urgency').value,
                status: 'Pending'
            };

            // Payload structure for GAS
            const payload = {
                action: 'insert',
                data: formData
            };

            if (GOOGLE_SCRIPT_URL) {
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                })
                .then(() => {
                    alert("Laporan Terkirim & Tersimpan!");
                    event.target.reset();
                    btn.innerText = "Kirim Laporan";
                    btn.disabled = false;
                    if(isAdmin) {
                        switchTab('dashboard');
                        setTimeout(fetchData, 1500); // Refresh list
                    }
                })
                .catch(err => {
                    alert("Error kirim data");
                    btn.disabled = false;
                });
            }
        }

        // --- CHARTS ---
        let catChart = null;
        let urgChart = null;

        function updateCharts(data) {
            // Process Data for Charts
            const catCounts = {};
            const urgCounts = [0,0,0,0,0]; // 1-5

            data.forEach(r => {
                // Category
                const cat = r.Kategori || r.category;
                catCounts[cat] = (catCounts[cat] || 0) + 1;
                
                // Urgency (Asumsi kolom Urgensi berisi angka)
                const urg = parseInt(r.Urgensi || r.urgency);
                if(urg >=1 && urg <=5) urgCounts[urg-1]++;
            });

            // Render Category Chart
            const ctxCat = document.getElementById('categoryChart').getContext('2d');
            if(catChart) catChart.destroy();
            catChart = new Chart(ctxCat, {
                type: 'bar',
                data: {
                    labels: Object.keys(catCounts),
                    datasets: [{
                        label: 'Kasus',
                        data: Object.values(catCounts),
                        backgroundColor: '#0ea5e9',
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Render Urgency Chart
            const ctxUrg = document.getElementById('urgencyChart').getContext('2d');
            if(urgChart) urgChart.destroy();
            urgChart = new Chart(ctxUrg, {
                type: 'line',
                data: {
                    labels: ['Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5'],
                    datasets: [{
                        label: 'Jumlah Kasus per Level',
                        data: urgCounts,
                        borderColor: '#f97316',
                        fill: true,
                        backgroundColor: 'rgba(249, 115, 22, 0.1)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- AI FEATURES (SIMPLIFIED) ---
        async function callGeminiAPI(prompt) {
            if (!apiKey) return alert("API Key Missing");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) { alert("AI Error"); return null; }
        }

        async function generateAnalysis() {
            const txt = document.getElementById('input-chronology').value;
            if(txt.length < 5) return alert("Isi kronologi dulu");
            const res = await callGeminiAPI("Analisis teknis singkat untuk masalah videotron/display ini: " + txt);
            if(res) {
                const div = document.getElementById('ai-analysis-result');
                div.classList.remove('hidden');
                div.innerText = res;
            }
        }

        async function generateReply() {
            const req = document.getElementById('input-request').value;
            if(!req) return alert("Pilih request dulu");
            const res = await callGeminiAPI("Buat draft WA sopan ke customer B2B mengenai tindak lanjut: " + req);
            if(res) {
                const div = document.getElementById('ai-reply-result');
                div.classList.remove('hidden');
                document.getElementById('reply-content').value = res;
            }
        }

        // Range Slider UI
        document.getElementById('input-urgency').addEventListener('input', function(e) {
            document.getElementById('urgency-val').innerText = e.target.value;
        });

    </script>
</body>
</html>

