<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microvision QC System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Configuration -->
    <script>
        const tailwindConfig = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 800: '#075985', 900: '#0c4a6e' },
                    }
                }
            }
        };

        if (typeof tailwind !== 'undefined') {
            tailwind.config = tailwindConfig;
        } else {
            window.addEventListener('load', function() {
                if (typeof tailwind !== 'undefined') {
                    tailwind.config = tailwindConfig;
                }
            });
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Status Badge Colors */
        .status-open { @apply bg-yellow-100 text-yellow-800 border border-yellow-200; }
        .status-closed { @apply bg-green-100 text-green-800 border border-green-200; }

        /* Upload Animation */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        
        /* Hover Delete Button */
        .preview-wrapper:hover .delete-btn { opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans leading-relaxed overflow-x-hidden">

    <!-- NOTIFICATION TOAST (New Feature) -->
    <div id="toast-notification" class="fixed top-5 right-5 z-[10000] hidden transition-all duration-500 transform translate-x-full opacity-0">
        <div class="flex items-center w-full max-w-sm p-4 bg-white rounded-lg shadow-lg border-l-4 border-green-500">
            <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg">
                <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/>
                </svg>
            </div>
            <div class="ml-3 text-sm font-normal text-slate-700">
                <span class="font-bold block text-slate-900">Sukses!</span>
                <span id="toast-message">Data berhasil disimpan.</span>
            </div>
            <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex items-center justify-center h-8 w-8" onclick="hideToast()">
                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- 1. LOGIN OVERLAY (Popup Modal) -->
    <div id="login-overlay" class="hidden fixed inset-0 bg-slate-900 bg-opacity-60 z-[9999] flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white p-8 rounded-2xl shadow-2xl border border-slate-100 max-w-sm w-full text-center relative fade-in">
            <button onclick="hideLogin()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>

            <!-- LOGO IMAGE -->
            <img src="https://raw.githubusercontent.com/MVI-PDN/Keluhan-Pelanggan/main/microvision-logo.webp" 
                 alt="Microvision Logo" 
                 class="h-12 mx-auto mb-6 object-contain"
                 onerror="this.style.display='none'; document.getElementById('login-logo-text').classList.remove('hidden')">
            
            <h1 id="login-logo-text" class="text-4xl font-bold text-brand-900 italic mb-4 tracking-wide hidden">Microvision</h1>

            <h2 class="text-lg font-semibold text-slate-600 mb-6 uppercase tracking-wider">Pengaduan Pelanggan</h2>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="email" id="login-email" required class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-brand-500 outline-none text-sm transition text-center">
                <button type="submit" class="w-full bg-brand-900 text-white py-3 rounded-lg font-bold hover:bg-brand-800 transition shadow-md text-sm">Masuk</button>
            </form>
            <p class="mt-4 text-[10px] text-slate-400">Khusus untuk Tim QC & Management</p>
        </div>
    </div>

    <!-- 2. APLIKASI UTAMA -->
    <div id="app-container" class="min-h-screen flex flex-col">
        
        <!-- Navigation Bar -->
        <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-3">
                        <img src="https://raw.githubusercontent.com/MVI-PDN/Keluhan-Pelanggan/main/microvision-logo.webp" 
                             alt="Microvision Logo" 
                             class="h-8 w-auto object-contain"
                             onerror="this.style.display='none'; document.getElementById('nav-logo-text').classList.remove('hidden')">
                        <h1 id="nav-logo-text" class="font-bold text-brand-900 text-2xl leading-tight italic tracking-wide hidden">Microvision</h1>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="switchTab('dashboard')" id="nav-dashboard" class="hidden px-4 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors">Dashboard</button>
                        <button onclick="switchTab('form')" id="nav-form" class="px-4 py-2 rounded-md text-sm font-medium bg-brand-50 text-brand-600 border border-brand-100 transition-colors shadow-sm">Laporan Baru</button>
                        <button id="btn-login-trigger" onclick="showLogin()" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-brand-900 hover:bg-brand-800 transition-colors shadow-sm">Login Admin</button>
                        <div id="user-panel" class="hidden flex items-center border-l pl-4 ml-2 gap-3">
                            <div class="text-right hidden md:block">
                                <span class="block text-xs font-bold text-slate-700" id="user-display">User</span>
                                <span class="block text-[10px] text-slate-400" id="role-display">Admin</span>
                            </div>
                            <button onclick="logout()" class="text-slate-400 hover:text-red-500 transition" title="Logout">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">

            <!-- DASHBOARD VIEW -->
            <section id="dashboard-view" class="hidden space-y-8 fade-in">
                <div class="flex justify-between items-end bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Quality Control Dashboard</h2>
                        <p class="text-slate-600 text-sm mt-1">Data Real-time dari Google Sheets.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadExcel()" class="text-xs font-bold bg-green-50 hover:bg-green-100 text-green-700 border border-green-200 px-4 py-2 rounded-lg transition flex items-center gap-2">üì• Download Excel</button>
                        <button onclick="fetchData()" class="text-xs font-bold bg-slate-50 hover:bg-slate-100 text-slate-600 border border-slate-200 px-4 py-2 rounded-lg transition flex items-center gap-2">üîÑ Refresh Data</button>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden group">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Total Kasus</h3>
                        <span class="text-3xl font-bold text-brand-600 mt-2 block" id="total-reports">...</span>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden group">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Kasus Open (Pending)</h3>
                        <span class="text-3xl font-bold text-orange-500 mt-2 block" id="pending-reports">...</span>
                        <div class="w-full bg-slate-100 rounded-full h-1 mt-4"><div id="bar-pending" class="bg-orange-500 h-1 rounded-full" style="width: 0%"></div></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden group">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Kasus Closed</h3>
                        <span class="text-3xl font-bold text-green-600 mt-2 block" id="closed-reports">...</span>
                        <div class="w-full bg-slate-100 rounded-full h-1 mt-4"><div id="bar-closed" class="bg-green-500 h-1 rounded-full" style="width: 0%"></div></div>
                    </div>
                </div>

                <!-- QUEUE LIST -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-bold text-lg text-slate-800">üìã Antrian Kasus (Live Queue)</h3>
                        <div class="text-xs px-3 py-1 bg-blue-50 text-blue-700 rounded-full border border-blue-100">Auto-sync</div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-4 font-bold">Tanggal</th>
                                    <th class="px-6 py-4 font-bold">Project</th>
                                    <th class="px-6 py-4 font-bold">Sales</th>
                                    <th class="px-6 py-4 font-bold">Masalah</th>
                                    <th class="px-6 py-4 font-bold text-center">Bukti</th> 
                                    <th class="px-6 py-4 font-bold text-center">Status</th>
                                    <th class="px-6 py-4 font-bold text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="case-table-body" class="divide-y divide-slate-100">
                                <tr><td colspan="7" class="px-6 py-8 text-center text-slate-400 italic">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Distribusi Kategori</h3>
                        <div class="chart-container"><canvas id="categoryChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Urgency Trend</h3>
                        <div class="chart-container"><canvas id="urgencyChart"></canvas></div>
                    </div>
                </div>
            </section>

            <!-- FORM VIEW -->
            <section id="form-view" class="fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">Formulir Keluhan Baru</h2>
                            <p class="text-slate-600 mb-6 text-sm">Lengkapi data teknis untuk analisis QC.</p>

                            <form id="complaintForm" class="space-y-8" onsubmit="handleFormSubmit(event)">
                                <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                    <h3 class="font-bold text-brand-900 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">IDENTITAS</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Nama Sales / PIC *</label>
                                            <input type="text" id="input-sales" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Tanggal Laporan *</label>
                                            <input type="date" id="input-date" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500">
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Nama Customer / PT *</label>
                                            <input type="text" id="input-customer" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500">
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">No PO / SPK *</label>
                                            <input type="text" id="input-po" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500">
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                    <h3 class="font-bold text-brand-900 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">DATA UNIT</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Tipe Produk / Model *</label>
                                            <input type="text" id="input-product" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500">
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Nama Project / Lokasi *</label>
                                            <input type="text" id="input-project" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500">
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Serial Number / Batch Modul</label>
                                            <input type="text" id="input-batch" class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Jml. Unit Bermasalah *</label>
                                            <input type="number" id="input-qty-bad" required class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500">
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                    <h3 class="font-bold text-brand-900 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">DETAIL MASALAH</h3>
                                    <div class="space-y-5">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Kategori Masalah *</label>
                                            <select id="input-category" required class="w-full rounded border-slate-300 p-2.5 border bg-white focus:ring-brand-500">
                                                <option value="">-- Pilih --</option>
                                                <option value="Dead Pixel">Dead Pixel / Lampu Mati</option>
                                                <option value="Modul Error">Modul Error / Blok Warna</option>
                                                <option value="Mati Total">Power Supply / Mati Total</option>
                                                <option value="No Signal">No Signal / Receiving Card</option>
                                                <option value="Fisik">Kerusakan Fisik / Pecah</option>
                                                <option value="Software">Software / Config</option>
                                                <option value="Lainnya">Lainnya</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Kronologi *</label>
                                            <textarea id="input-chronology" required rows="4" class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- CUSTOM UPLOAD CARD -->
                                <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                    <h3 class="font-bold text-brand-900 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">BUKTI DOKUMENTASI</h3>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Bukti Foto/Video (Max 5MB) <span class="text-red-600">*</span></label>
                                        
                                        <!-- Custom Upload Area -->
                                        <div id="upload-area" class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-white hover:border-brand-300 transition cursor-pointer relative" onclick="document.getElementById('input-evidence').click()">
                                            <input type="file" id="input-evidence" accept="image/*,video/*" class="hidden" onchange="handleFileSelect(this)">
                                            
                                            <div id="upload-placeholder" class="space-y-2">
                                                <div class="mx-auto h-12 w-12 text-slate-300">
                                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                    </svg>
                                                </div>
                                                <div class="text-sm text-slate-500 font-medium">Klik untuk upload foto/video</div>
                                                <p class="text-xs text-slate-400">Support: JPG, PNG, MP4</p>
                                            </div>
                                        </div>

                                        <!-- Preview State -->
                                        <div id="preview-container" class="hidden mt-4 relative group w-full max-w-xs mx-auto border rounded-lg overflow-hidden preview-wrapper">
                                            <div id="preview-content" class="bg-slate-100 flex items-center justify-center h-48 w-full"></div>
                                            <!-- Hover Delete Button -->
                                            <button type="button" onclick="removeFile(event)" class="delete-btn opacity-0 transition-opacity absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-1.5 shadow-md z-10" title="Hapus File">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                            </button>
                                            <div class="bg-white px-3 py-2 text-xs text-slate-600 truncate border-t" id="filename-display">filename.jpg</div>
                                        </div>

                                        <p class="text-[10px] text-red-500 mt-2 font-medium flex items-center gap-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                            Wajib diisi untuk klaim garansi.
                                        </p>
                                    </div>
                                </div>

                                <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                    <h3 class="font-bold text-brand-900 mb-4 text-sm bg-brand-100 inline-block px-2 py-1 rounded">TINDAK LANJUT</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Tanggal Kebutuhan</label>
                                            <input type="date" id="input-need-date" class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Estimasi Kembali (Max 90 Hari)</label>
                                            <input type="date" id="input-return-date" class="w-full rounded border-slate-300 p-2.5 border focus:ring-brand-500">
                                        </div>

                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Request Customer *</label>
                                            <select id="input-request" required class="w-full rounded border-slate-300 p-2.5 border bg-white mb-2 focus:ring-brand-500">
                                                <option value="Service On-site">Kunjungan Teknisi</option>
                                                <option value="Sparepart">Kirim Sparepart</option>
                                                <option value="Replace Unit">Ganti Unit Baru</option>
                                                <option value="Remote">Bantuan Remote</option>
                                            </select>
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Urgensi (1-5)</label>
                                            <input id="input-urgency" type="range" min="1" max="5" value="3" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-brand-600">
                                            <div class="text-center text-xs font-bold text-brand-700 mt-1">Level: <span id="urgency-val">3</span></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-end gap-3 pt-4">
                                    <button type="button" onclick="if(isAdmin) switchTab('dashboard')" class="px-6 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100 transition-colors">Batal</button>
                                    <button type="submit" id="btn-submit" class="px-6 py-2.5 rounded-lg text-sm font-medium bg-brand-900 text-white hover:bg-brand-800 shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center justify-center min-w-[140px]">
                                        <span>Kirim Laporan</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-1">
                        <div class="bg-brand-50 p-6 rounded-xl border border-brand-100 sticky top-24">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-xl">üí°</span>
                                <h3 class="font-bold text-brand-900">Info Penting</h3>
                            </div>
                            <p class="text-sm text-brand-700 mb-4 leading-relaxed">
                                Pastikan <strong>Serial Number (SN)</strong> dan <strong>Batch Modul</strong> tercatat untuk keperluan klaim garansi.
                            </p>
                            <div class="h-px bg-brand-200 my-4"></div>
                            <p class="text-sm text-brand-700 leading-relaxed">
                                Gunakan kolom <strong>Nama Project</strong> untuk memudahkan teknisi melacak lokasi.
                            </p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- LOGIC -->
    <script>
        // NEW UPDATED SCRIPT URL
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwPOhWrv8_ujtGiTSPC1qaBsmtGckNh4y0_YWDyJMwFg8zPtQsCAdRykAT_VCdx-pfp/exec"; 
        const ADMIN_KEYWORDS = ['admin', 'qc', 'boss', 'spv', 'manager']; 
        let isAdmin = false;
        let currentUser = "";
        let currentFile = null; 

        // AUTH & SESSION
        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('mv_user');
            if (savedUser) {
                const email = savedUser;
                document.getElementById('user-display').innerText = email.split('@')[0];
                
                if (ADMIN_KEYWORDS.some(role => email.includes(role))) {
                    isAdmin = true;
                    document.getElementById('nav-dashboard').classList.remove('hidden');
                    document.getElementById('btn-login-trigger').classList.add('hidden');
                    document.getElementById('user-panel').classList.remove('hidden');
                    document.getElementById('role-display').innerText = "Administrator";
                    fetchData(); 
                }
            }
            
            // Set Date Limits
            const today = new Date();
            const maxDate = new Date();
            maxDate.setDate(today.getDate() + 90);
            const returnDateInput = document.getElementById('input-return-date');
            returnDateInput.min = today.toISOString().split('T')[0];
            returnDateInput.max = maxDate.toISOString().split('T')[0];
        });

        function showLogin() { document.getElementById('login-overlay').classList.remove('hidden'); }
        function hideLogin() { document.getElementById('login-overlay').classList.add('hidden'); }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.toLowerCase();
            hideLogin();
            document.getElementById('user-display').innerText = email.split('@')[0];

            if (ADMIN_KEYWORDS.some(role => email.includes(role))) {
                isAdmin = true;
                localStorage.setItem('mv_user', email);
                document.getElementById('nav-dashboard').classList.remove('hidden');
                document.getElementById('btn-login-trigger').classList.add('hidden');
                document.getElementById('user-panel').classList.remove('hidden');
                document.getElementById('role-display').innerText = "Administrator";
                switchTab('dashboard'); 
                fetchData(); 
            } else {
                alert("Akses Dashboard ditolak. Email tidak terdaftar sebagai Admin/QC.");
            }
        }

        function logout() {
            localStorage.removeItem('mv_user');
            location.reload(); 
        }

        function switchTab(tabName) {
            const dashboard = document.getElementById('dashboard-view');
            const form = document.getElementById('form-view');
            const btnDash = document.getElementById('nav-dashboard');
            const btnForm = document.getElementById('nav-form');

            if (tabName === 'dashboard') {
                if (!isAdmin) return; 
                dashboard.classList.remove('hidden');
                form.classList.add('hidden');
                btnDash.className = "px-4 py-2 rounded-md text-sm font-medium bg-brand-50 text-brand-600 border border-brand-100 transition-colors shadow-sm";
                btnForm.className = "px-4 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors";
                fetchData(); 
            } else {
                dashboard.classList.add('hidden');
                form.classList.remove('hidden');
                btnForm.className = "px-4 py-2 rounded-md text-sm font-medium bg-brand-50 text-brand-600 border border-brand-100 transition-colors shadow-sm";
                btnDash.className = "px-4 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors";
                document.getElementById('input-date').valueAsDate = new Date();
            }
        }

        // FETCH DATA
        async function fetchData() {
            if (!GOOGLE_SCRIPT_URL) return;
            const tableBody = document.getElementById('case-table-body');
            if(tableBody.children.length <= 1) {
                tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-slate-500">‚è≥ Mengambil data...</td></tr>';
            }

            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?t=${new Date().getTime()}`, { redirect: "follow" }); 
                const data = await response.json();
                allReports = data;
                renderDashboard(data);
            } catch (error) {
                console.error("Fetch Error:", error);
                tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-red-500 bg-red-50 rounded-lg">Gagal koneksi. Periksa Permission Script ("Anyone") atau CORS.</td></tr>';
            }
        }

        function renderDashboard(data) {
            document.getElementById('total-reports').innerText = data.length;
            const pendingCount = data.filter(r => r.Status !== 'Closed').length;
            document.getElementById('pending-reports').innerText = pendingCount;
            document.getElementById('closed-reports').innerText = data.length - pendingCount;

            const total = data.length || 1;
            document.getElementById('bar-pending').style.width = `${(pendingCount/total)*100}%`;
            document.getElementById('bar-closed').style.width = `${((data.length - pendingCount)/total)*100}%`;

            const tableBody = document.getElementById('case-table-body');
            tableBody.innerHTML = '';
            
            const sortedData = [...data].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));

            sortedData.forEach(row => {
                const id = row.id;
                const isClosed = row.Status === 'Closed';
                let dateStr = '-';
                if(row.Date) {
                    const d = new Date(row.Date);
                    if(!isNaN(d.getTime())) dateStr = d.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
                }

                // Evidence Link
                const evidenceLink = (row.Evidence && row.Evidence !== '-' && !row.Evidence.startsWith('Error')) 
                    ? `<a href="${row.Evidence}" target="_blank" class="text-blue-600 hover:underline">Lihat</a>`
                    : '<span class="text-slate-400">-</span>';

                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-slate-50 transition";
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-slate-500">${dateStr}</td>
                    <td class="px-6 py-4"><div class="text-sm font-bold text-slate-800">${row.Project || '-'}</div><div class="text-xs text-slate-500">${row.Product || ''}</div></td>
                    <td class="px-6 py-4 text-slate-600">${row.Sales}</td>
                    <td class="px-6 py-4"><span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-slate-100 text-slate-600 mb-1">${row.Category}</span></td>
                    <td class="px-6 py-4 text-center text-xs">${evidenceLink}</td>
                    <td class="px-6 py-4 text-center"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${isClosed ? 'status-closed' : 'status-open'}">${isClosed ? 'Closed' : 'Open'}</span></td>
                    <td class="px-6 py-4 text-center">
                        ${!isClosed ? 
                            `<button onclick="updateStatus('${id}', 'Closed')" class="text-xs font-medium text-green-600 hover:text-green-800 border border-green-200 bg-green-50 hover:bg-green-100 px-3 py-1 rounded-md transition">‚úÖ Close</button>` : 
                            `<button onclick="updateStatus('${id}', 'Open')" class="text-xs font-medium text-slate-500 hover:text-slate-700 border border-slate-200 hover:bg-slate-100 px-3 py-1 rounded-md transition">‚Ü© Re-open</button>`
                        }
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            updateCharts(data);
        }

        async function updateStatus(id, newStatus) {
            if(!confirm(`Ubah status menjadi ${newStatus}?`)) return;
            const payload = { action: 'update_status', id: id, status: newStatus };
            try {
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                setTimeout(fetchData, 2000); 
            } catch(e) { alert("Gagal update status."); }
        }

        // --- TOAST NOTIFICATION ---
        function showToast() {
            const toast = document.getElementById('toast-notification');
            toast.classList.remove('hidden');
            // Trigger reflow
            void toast.offsetWidth;
            toast.classList.remove('translate-x-full', 'opacity-0');
            
            // Auto hide
            setTimeout(hideToast, 5000);
        }

        function hideToast() {
            const toast = document.getElementById('toast-notification');
            toast.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 500); // Wait for transition
        }

        // --- FILE HANDLING ---
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert("Ukuran file terlalu besar! Maksimal 5MB.");
                    input.value = ''; return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewContent = document.getElementById('preview-content');
                    if (file.type.startsWith('image/')) previewContent.innerHTML = `<img src="${e.target.result}" class="h-full w-full object-cover">`;
                    else if (file.type.startsWith('video/')) previewContent.innerHTML = `<video src="${e.target.result}" class="h-full w-full object-cover" controls></video>`;
                    
                    document.getElementById('filename-display').innerText = file.name;
                    document.getElementById('upload-area').classList.add('hidden');
                    document.getElementById('preview-container').classList.remove('hidden');
                    currentFile = file;
                };
                reader.readAsDataURL(file);
            }
        }

        function removeFile(event) {
            if(event) event.stopPropagation();
            document.getElementById('input-evidence').value = ''; 
            currentFile = null; 
            document.getElementById('upload-area').classList.remove('hidden');
            document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('preview-content').innerHTML = '';
        }

        const getBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); 
                reader.onerror = error => reject(error);
            });
        };

        async function handleFormSubmit(event) {
            event.preventDefault();
            const btn = document.getElementById('btn-submit');
            const originalText = btn.innerText;
            btn.innerHTML = `<div class="spinner mr-2"></div> Mengirim...`;
            btn.disabled = true;

            // VALIDATION
            if (!currentFile) {
                alert("Wajib upload bukti Foto/Video!");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            let fileData = null;
            try {
                const base64Content = await getBase64(currentFile);
                fileData = { name: currentFile.name, type: currentFile.type, content: base64Content };
            } catch (e) {
                alert("Gagal memproses file.");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            const formData = {
                sales: document.getElementById('input-sales').value,
                date: document.getElementById('input-date').value,
                customer: document.getElementById('input-customer').value,
                po: document.getElementById('input-po').value,
                product: document.getElementById('input-product').value,
                batch: document.getElementById('input-batch').value,
                project: document.getElementById('input-project').value, 
                qtyBad: document.getElementById('input-qty-bad').value,
                category: document.getElementById('input-category').value,
                chronology: document.getElementById('input-chronology').value,
                request: document.getElementById('input-request').value,
                urgency: document.getElementById('input-urgency').value,
                needDate: document.getElementById('input-need-date').value,
                returnDate: document.getElementById('input-return-date').value,
                file: fileData 
            };

            const payload = { action: 'insert', data: formData };

            if (GOOGLE_SCRIPT_URL) {
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                })
                .then(() => {
                    // Show Notification Toast
                    showToast();
                    
                    event.target.reset();
                    removeFile(); 
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    if(isAdmin) { switchTab('dashboard'); setTimeout(fetchData, 2000); }
                })
                .catch(err => {
                    alert("Gagal kirim.");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            } else {
                alert("URL Script belum diset.");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        let catChart = null;
        let urgChart = null;

        function updateCharts(data) {
            const catCounts = {};
            const urgCounts = [0,0,0,0,0]; 

            data.forEach(r => {
                const cat = r.Category || 'Lainnya';
                catCounts[cat] = (catCounts[cat] || 0) + 1;
                const urg = parseInt(r.Urgency);
                if(urg >=1 && urg <=5) urgCounts[urg-1]++;
            });

            const ctxCat = document.getElementById('categoryChart').getContext('2d');
            if(catChart) catChart.destroy();
            catChart = new Chart(ctxCat, {
                type: 'bar',
                data: {
                    labels: Object.keys(catCounts),
                    datasets: [{ label: 'Jumlah Kasus', data: Object.values(catCounts), backgroundColor: '#0ea5e9', borderRadius: 6 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} } }
            });

            const ctxUrg = document.getElementById('urgencyChart').getContext('2d');
            if(urgChart) urgChart.destroy();
            urgChart = new Chart(ctxUrg, {
                type: 'line',
                data: {
                    labels: ['Low', 'Normal', 'Medium', 'High', 'Urgent'],
                    datasets: [{ label: 'Frekuensi Urgensi', data: urgCounts, borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', fill: true, tension: 0.4 }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function downloadExcel() {
            if (!allReports || allReports.length === 0) {
                alert("Belum ada data untuk didownload.");
                return;
            }
            const headers = Object.keys(allReports[0]);
            const csvRows = [];
            csvRows.push(headers.join(','));
            for (const row of allReports) {
                const values = headers.map(header => {
                    const escaped = ('' + row[header]).replace(/"/g, '\\"'); 
                    return `"${escaped}"`; 
                });
                csvRows.push(values.join(','));
            }
            const csvData = csvRows.join('\n');
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'laporan_qc_microvision.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        document.getElementById('input-urgency').addEventListener('input', function(e) {
            document.getElementById('urgency-val').innerText = e.target.value;
        });
        document.getElementById('input-date').valueAsDate = new Date();
    </script>
</body>
</html>




